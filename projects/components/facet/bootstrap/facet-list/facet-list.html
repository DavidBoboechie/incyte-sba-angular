<div [hidden]="isHidden()" class="list-group list-group-flush pb-1">

    <div *ngIf="searchMode" [formGroup]="searchGroup">
        <div class="p-1">
            <input class="form-control"
                type="search" spellcheck="false" autocomplete="off"
                formControlName="searchQuery"
                [placeholder]="'msg#facet.searchPlaceholder' | sqMessage">
        </div>
        <sq-loading-bar [active]="searchActive | async"></sq-loading-bar>
    </div>

    <ng-container *ngFor="let item of items"
        [ngTemplateOutlet]="itemTpl"
        [ngTemplateOutletContext]="{$implicit: item}">
    </ng-container>

    <span *ngIf="suggests?.length === 0" class="d-block text-center text-muted small py-1">
        <i>{{'msg#facet.searchNoResult' | sqMessage}}</i>
    </span>

    <a *ngIf="!suggests && data?.$hasMore" class="d-block border-0 text-center" (click)="loadMore()" href="#">
        <span *ngIf="searchActive | async; else loadMoreTpl" class="fas fa-sync fa-fw fa-spin"></span>
        <ng-template #loadMoreTpl>
            <small>{{'msg#facet.loadMore' | sqMessage}}</small>
        </ng-template>
    </a>

</div>

<!-- Template for displaying an aggregation item-->
<ng-template #itemTpl let-item>
    <div class="list-group-item list-group-item-action d-flex"
        [ngClass]="{'sq-selected': item.$selected, 'sq-filtered': item.$filtered}"
        [title]="(item.$selected? 'msg#facet.itemUnselect' : 'msg#facet.itemSelect') | sqMessage"
        (click)="selectItem(item)">

        <!-- Tree aggregation opener -->
        <span *ngIf="data?.isTree" class="item-opener" [ngStyle]="{'--depth' : item.$level ?? 0}">
            <a *ngIf="item.hasChildren" href="#" (click)="open(item, $event)" [title]="(item.$opened ? 'msg#facet.closeItem' : 'msg#facet.openItem') | sqMessage">
                <span *ngIf="item.$opening" class="fas fa-sync fa-fw fa-spin"></span>
                <span *ngIf="!item.$opening && item.$opened" class="fas fa-caret-down fa-fw"></span>
                <span *ngIf="!item.$opening && !item.$opened" class="fas fa-caret-right fa-fw"></span>
            </a>
            <span *ngIf="!item.hasChildren" class="fas fa-fw"></span>
        </span>

        <!-- Checkbox for multi-selection -->
        <input type="checkbox" class="form-check-input me-2"
            [checked]="item.$selected || item.$filtered"
            [disabled]="item.$filtered"
            (change)="selectItem(item)"
            (click)="$event.stopPropagation()"
            *ngIf="showCheckbox">

        <!-- item display / value -->
        <a  href="#" (click)="filterItem(item, $event)"
            [title]="'msg#facet.filterItem' | sqMessage:{'terme':(item | sqValue:item.$column)}"
            class="text-truncate me-auto">
            {{item | sqValue:item.$column}}
        </a>

        <!-- Item counter -->
        <span *ngIf="showCount && item.count" class="ms-2 text-muted small" style="z-index: 1;">{{item.count | sqNumber}}</span>
    </div>

    <!-- Tree aggregation sub-elements -->
    <ng-container *ngIf="item.$opened">
        <ng-container *ngFor="let i of item.items"
            [ngTemplateOutlet]="itemTpl"
            [ngTemplateOutletContext]="{$implicit: i}">
        </ng-container>
    </ng-container>
</ng-template>
